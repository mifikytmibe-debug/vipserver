#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Roblox VIP Link Bot (Telegram)
--------------------------------
‚Ä¢ –í—ã–¥–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ/VIP-—Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö Roblox –∏–≥—Ä –≤ –≤–∏–¥–µ –∫–Ω–æ–ø–æ–∫.
‚Ä¢ –ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª @thespikeacc.
‚Ä¢ –ö–Ω–æ–ø–∫–∞ "–Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è" –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.
"""

import os
import re
import time
import logging
from typing import Dict, Optional
from dotenv import load_dotenv
import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton, Message, CallbackQuery

# -------------------- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ --------------------
load_dotenv()
BOT_TOKEN = os.getenv("BOT_TOKEN", "").strip()
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω. –£–∫–∞–∂–∏—Ç–µ –µ–≥–æ –≤ .env")

ADMIN_IDS = {
    int(x.strip())
    for x in os.getenv("ADMIN_IDS", "").split(",")
    if x.strip().isdigit()
}

# –ö–∞–Ω–∞–ª –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
CHANNEL_USERNAME = "@thespikeacc"

# -------------------- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ --------------------
logging.basicConfig(
    filename="bot.log",
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(name)s: %(message)s",
)
logger = logging.getLogger("roblox_vip_bot")

# -------------------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ --------------------
bot = telebot.TeleBot(BOT_TOKEN, parse_mode="HTML")

# -------------------- –°–ø–∏—Å–æ–∫ –∏–≥—Ä --------------------
GAME_SLUGS: Dict[str, str] = {
    "Adopt Me": "ADOPT_ME",
    "Grow A Garden": "GROW_A_GARDEN",
    "Murder Mystery 2": "MURDER_MYSTERY_2",
    "Jailbreak": "JAILBREAK",
    "Blox Fruits": "BLOX_FRUITS",
    "Pls Donate": "PLS_DONATE",
}

# -------------------- –†–µ–≥—É–ª—è—Ä–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ URL --------------------
URL_RE = re.compile(r"^https?://[^\s]+$", re.IGNORECASE)

# -------------------- –ê–Ω—Ç–∏—Å–ø–∞–º --------------------
USER_LAST_TS: Dict[int, float] = {}
COOLDOWN_SECONDS = 1.0

def is_admin(user_id: int) -> bool:
    return user_id in ADMIN_IDS

def env_key_for_slug(slug: str) -> str:
    return f"LINK_{slug}"

def get_link_by_slug(slug: str) -> Optional[str]:
    return os.getenv(env_key_for_slug(slug))

def set_link_by_slug(slug: str, url: str) -> None:
    os.environ[env_key_for_slug(slug)] = url

def validate_url(url: str) -> bool:
    return bool(URL_RE.match(url))

def rate_limit_ok(user_id: int) -> bool:
    now = time.time()
    last = USER_LAST_TS.get(user_id, 0.0)
    if now - last < COOLDOWN_SECONDS:
        return False
    USER_LAST_TS[user_id] = now
    return True

# -------------------- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ --------------------
def is_subscribed(user_id: int) -> bool:
    try:
        chat_member = bot.get_chat_member(CHANNEL_USERNAME, user_id)
        return chat_member.status in ["member", "administrator", "creator"]
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏: {e}")
        return False

def subscribe_kb() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("‚úÖ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è", url=f"https://t.me/{CHANNEL_USERNAME.lstrip('@')}"))
    kb.add(InlineKeyboardButton("üîÑ –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è", callback_data="check_sub"))
    return kb

# -------------------- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã --------------------
def main_menu_kb() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup(row_width=2)
    buttons = []
    for title, slug in GAME_SLUGS.items():
        buttons.append(InlineKeyboardButton(text=title, callback_data=f"game:{slug}"))
    for i in range(0, len(buttons), 2):
        kb.row(*buttons[i:i+2])
    kb.row(
        InlineKeyboardButton("‚ÑπÔ∏è –û –±–æ—Ç–µ", callback_data="about"),
        InlineKeyboardButton("üßæ –í—Å–µ —Å—Å—ã–ª–∫–∏", callback_data="list_all"),
    )
    return kb

def links_kb(links: Dict[str, str]) -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup()
    for title, url in links.items():
        kb.add(InlineKeyboardButton(f"üîó {title}", url=url))
    kb.add(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_main"))
    return kb

def admin_menu_kb() -> InlineKeyboardMarkup:
    kb = InlineKeyboardMarkup(row_width=2)
    for title, slug in GAME_SLUGS.items():
        kb.add(InlineKeyboardButton(f"‚úèÔ∏è {title}", callback_data=f"admin:set:{slug}"))
    kb.add(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_main"))
    return kb

def title_by_slug(slug: str) -> str:
    for title, s in GAME_SLUGS.items():
        if s == slug:
            return title
    return slug

# -------------------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ --------------------
@bot.message_handler(commands=["start"])
def cmd_start(message: Message):
    if not is_subscribed(message.from_user.id):
        bot.send_message(message.chat.id, "üö´ –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª!", reply_markup=subscribe_kb())
        return
    if not rate_limit_ok(message.from_user.id):
        return
    bot.send_message(message.chat.id, "<b>–ü—Ä–∏–≤–µ—Ç!</b>\n–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É –Ω–∏–∂–µ üëá", reply_markup=main_menu_kb())

@bot.message_handler(commands=["links"])
def cmd_links(message: Message):
    if not is_subscribed(message.from_user.id):
        bot.send_message(message.chat.id, "üö´ –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª!", reply_markup=subscribe_kb())
        return
    if not rate_limit_ok(message.from_user.id):
        return
    links = {title: url for title, slug in GAME_SLUGS.items() if (url := get_link_by_slug(slug))}
    if not links:
        bot.send_message(message.chat.id, "‚ö†Ô∏è –°—Å—ã–ª–∫–∏ –ø–æ–∫–∞ –Ω–µ –∑–∞–¥–∞–Ω—ã.")
        return
    bot.send_message(message.chat.id, "<b>–°—Å—ã–ª–∫–∏ –Ω–∞ –≤—Å–µ –∏–≥—Ä—ã:</b>", reply_markup=links_kb(links))

@bot.message_handler(commands=["admin"])
def cmd_admin(message: Message):
    if not is_subscribed(message.from_user.id):
        bot.send_message(message.chat.id, "üö´ –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª!", reply_markup=subscribe_kb())
        return
    if not rate_limit_ok(message.from_user.id):
        return
    if not is_admin(message.from_user.id):
        bot.reply_to(message, "‚õî –ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.")
        return
    bot.send_message(message.chat.id, "<b>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>", reply_markup=admin_menu_kb())

# -------------------- Callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ --------------------
@bot.callback_query_handler(func=lambda c: c.data == "check_sub")
def check_subscription(call: CallbackQuery):
    if is_subscribed(call.from_user.id):
        bot.send_message(call.message.chat.id, "‚úÖ –û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º.", reply_markup=main_menu_kb())
    else:
        bot.send_message(call.message.chat.id, "‚ùå –í—ã –≤—Å—ë –µ—â—ë –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", reply_markup=subscribe_kb())

@bot.callback_query_handler(func=lambda c: True)
def on_callback(call: CallbackQuery):
    if not is_subscribed(call.from_user.id):
        bot.send_message(call.message.chat.id, "üö´ –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª!", reply_markup=subscribe_kb())
        return
    data = call.data or ""
    if data.startswith("game:"):
        slug = data.split(":", 1)[1]
        title = title_by_slug(slug)
        url = get_link_by_slug(slug)
        if url:
            bot.send_message(call.message.chat.id, f"<b>{title}</b>\n–ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", reply_markup=links_kb({title: url}))
        else:
            bot.send_message(call.message.chat.id, f"‚ö†Ô∏è –°—Å—ã–ª–∫–∞ –¥–ª—è <b>{title}</b> –Ω–µ –∑–∞–¥–∞–Ω–∞.")
    elif data == "about":
        bot.send_message(call.message.chat.id, "–≠—Ç–æ—Ç –±–æ—Ç –≤—ã–¥–∞—ë—Ç VIP-—Å—Å—ã–ª–∫–∏ –Ω–∞ Roblox —Å–µ—Ä–≤–µ—Ä–∞.")
    elif data == "list_all":
        links = {title: url for title, slug in GAME_SLUGS.items() if (url := get_link_by_slug(slug))}
        if not links:
            bot.send_message(call.message.chat.id, "‚ö†Ô∏è –°—Å—ã–ª–∫–∏ –ø–æ–∫–∞ –Ω–µ –∑–∞–¥–∞–Ω—ã.")
        else:
            bot.send_message(call.message.chat.id, "<b>–°—Å—ã–ª–∫–∏ –Ω–∞ –≤—Å–µ –∏–≥—Ä—ã:</b>", reply_markup=links_kb(links))
    elif data.startswith("admin:set:"):
        if not is_admin(call.from_user.id):
            bot.answer_callback_query(call.id, text="–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤")
            return
        slug = data.split(":")[-1]
        title = title_by_slug(slug)
        msg = bot.send_message(call.message.chat.id, f"‚úèÔ∏è –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É –¥–ª—è <b>{title}</b>. –û—Ç–ø—Ä–∞–≤—å—Ç–µ '–æ—Ç–º–µ–Ω–∞' –¥–ª—è –æ—Ç–º–µ–Ω—ã.")
        bot.register_next_step_handler(msg, handle_new_link_input, slug)
    elif data == "back_main":
        bot.edit_message_text("–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É –Ω–∏–∂–µ üëá", chat_id=call.message.chat.id, message_id=call.message.message_id, reply_markup=main_menu_kb())

# -------------------- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–π —Å—Å—ã–ª–∫–∏ --------------------
def handle_new_link_input(message: Message, slug: str):
    if not is_admin(message.from_user.id):
        bot.reply_to(message, "‚õî –ù–µ—Ç –ø—Ä–∞–≤.")
        return
    text = (message.text or "").strip()
    if text.lower() == "–æ—Ç–º–µ–Ω–∞":
        bot.send_message(message.chat.id, "–û—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=admin_menu_kb())
        return
    if not validate_url(text):
        msg = bot.send_message(message.chat.id, "‚ùå –≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Å—Å—ã–ª–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ '–æ—Ç–º–µ–Ω–∞'.")
        bot.register_next_step_handler(msg, handle_new_link_input, slug)
        return
    set_link_by_slug(slug, text)
    bot.send_message(message.chat.id, f"‚úÖ –°—Å—ã–ª–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è <b>{title_by_slug(slug)}</b>.", reply_markup=admin_menu_kb())

# -------------------- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ --------------------
if __name__ == "__main__":
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω.")
    bot.infinity_polling(timeout=60, long_polling_timeout=50)
